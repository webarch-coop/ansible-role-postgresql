---
- name: Tasks to create a cronjob to dump all PostgreSQL databases
  block:

    - name: Include tasks to get the HOME directory for the PostgreSQL user
      include_tasks: home.yml

    - name: Backup directory present
      file:
        path: "{{ postgresql_backups }}"
        state: directory
        owner: "{{ postgresql_user | default('postgres') }}"
        group: "{{ postgresql_user | default('postgres') }}"
        mode: 0700

    - name: List the PostgreSQL databases
      shell: psql -Stc "SELECT datname FROM pg_database"
      args:
        executable: /bin/bash
        chdir: "{{ postgresql_postgres_home | default('/var/backups/postgres') }}"
      environment:
        PAGER: ""
      register: postgresql_datnames
      become: true
      become_user: "{{ postgresql_user | default('postgres') }}"

    - name: Generate an array of the database names
      set_fact:
        postgresql_databases: "{{ postgresql_databases | default([]) }} + [ '{{ line | trim }}' ]"
      when:
        - ( line | length > 0 )
        - ( line != "template0" )
        - ( line != "template1" )
      loop: "{{ postgresql_datnames.stdout_lines }}"
      loop_control:
        loop_var: line

    - name: Crontab present
      cron:
        user: "{{ postgresql_user | default('postgres') }}"
        name: "Dump PostgreSQL databases"
        job: "{% for d in postgresql_databases %}pg_dump {{ d }} > {{ postgresql_backups | default('/var/backups/postgres') }}/{{ d }}.sql ; {% endfor %}"
        hour: "{{ postgresql_cron_hour | default('02') }}"
        minute: "{{ 59 | random }}"

  tags:
    - postgresql
...
