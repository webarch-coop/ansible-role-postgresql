---
- name: PostgreSQL user present
  block:

    - name: Getent passwd
      getent:
        database: passwd

    - name: Set a variable for the HOME directory of the postgres user
      set_fact:
        postgresql_home: "{{ user.value[4] }}"
      when: user.key == postgres
      loop: "{{ getent_passwd | dict2items }}"
      loop_control:
        loop_var: user
        label: "{{ user.key }}"

    - name: Debug the postgres HOME directory
      debug:
        var: postgresql_home
        verbosity: 1

    - fail:

    - name: "PostgreSQL password for {{ postgresql_user }} present"
      shell: "pwgen -n 20 1 > /root/.postgresql.{{ postgresql_user }}.passwd"
      no_log: true
      args:
        creates: "/root/.postgresql.{{ postgresql_user }}.passwd"

    - name: "PostgreSQL password /root/.postgresql.{{ postgresql_user }}.passwd slurped"
      slurp:
        src: "/root/.postgresql.{{ postgresql_user }}.passwd"
      no_log: true
      register: postgresql_passwd_file_b64encoded

    - name: Fact set for the PostgreSQL password
      set_fact:
        postgresql_passwd: "{{ postgresql_passwd_file_b64encoded['content'] | b64decode | trim }}"
      no_log: true

    - name: PostgreSQL user present
      postgresql_user:
        name: "{{ postgresql_user }}"
        password: "{{ postgresql_passwd }}"
        db: "{{ postgresql_db }}"
        priv: ALL
        state: present
      become: true
      become_user: postgres

  when:
    - ( postgresql_db is defined )
    - ( postgresql_db | length > 0 )
    - ( postgresql_user is defined )
    - ( postgresql_user | length > 0 )
  tags:
    - postgresql
...
