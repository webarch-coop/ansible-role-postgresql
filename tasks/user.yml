---
- name: PostgreSQL user present
  block:

    - name: Getent passwd
      getent:
        database: passwd

    - name: Set a variable for the HOME directory of the postgres user
      set_fact:
        postgresql_home: "{{ user.value[4] }}"
      when: user.key == "postgres"
      loop: "{{ getent_passwd | dict2items }}"
      loop_control:
        loop_var: user
        label: "{{ user.key }}"

    - name: Debug the postgres HOME directory
      debug:
        var: postgresql_home
        verbosity: 1

    - name: Set the postgresql_password variable to be an empty string
      set_fact:
        postgresql_password: ""

    - name: "Check if {{ postgresql_home }}/.pgpass exists"
      stat:
        path: "{{ postgresql_home }}/.pgpass"
      register: postgresql_home_pgpass_stat

    - name: Read the PostgreSQL password from the .pgpass file
      include_tasks: pgpass_read.yml
      when: ( postgresql_home_pgpass_stat is defined ) and ( postgresql_home_pgpass_stat.stat.exists )
    
    - name: Generate a PostgreSQL password and write it to .pgpass
      include_tasks: pgpass_write.yml
      when:
        - ( postgresql_home_pgpass_stat is defined ) and ( not postgresql_home_pgpass_stat.stat.exists )
        - ( postgresql_password is not defined ) or ( postgresql_password is defined and postgresql_password | length <= 0 )

    - name: PostgreSQL user present
      postgresql_user:
        name: "{{ postgresql_user }}"
        password: "{{ postgresql_password }}"
        db: "{{ postgresql_db }}"
        priv: ALL
        state: present
      become: true
      become_user: postgres

  when:
    - ( postgresql_db is defined )
    - ( postgresql_db | length > 0 )
    - ( postgresql_user is defined )
    - ( postgresql_user | length > 0 )
  tags:
    - postgresql
...
